<!DOCTYPE html>
<html>
<head>
  <title>Preguntas</title>
  <meta charset="UTF-8">
</head>
<body>
<h1>Preguntas</h1>

<div id="preguntaContainer"></div>
<button id="avanzarBtn">Avanzar</button>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const encuestaId = urlParams.get('encuestaId');

    if (!encuestaId) {
      console.log("El parámetro 'encuestaId' es nulo. Verifica la URL.");
      return;
    }

    var preguntas = [];
    var indicePregunta = 0;
    var respuestas = [];

    function obtenerPreguntas(encuestaId) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/encuesta/mostrar/" + encuestaId + "/preguntas", true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          preguntas = JSON.parse(xhr.responseText);
          mostrarPregunta(indicePregunta);
        }
      };
      xhr.send();
    }

    function guardarRespuesta(preguntaId, opcionId, opcionTexto) {
      respuestas.push({
        preguntaId: preguntaId,
        opcionId: opcionId,
        enunciadoOpcion: opcionTexto
      });
    }


    function mostrarPregunta(indice) {
      var preguntaContainer = document.getElementById("preguntaContainer");
      preguntaContainer.innerHTML = "";

      var pregunta = preguntas[indice];

      var preguntaItem = document.createElement("div");
      preguntaItem.innerText = pregunta.pregunta;
      preguntaItem.dataset.preguntaId = pregunta.id;

      var opcionesList = document.createElement("ul");
      pregunta.opciones.forEach(function(opcion) {
        var opcionItem = document.createElement("li");

        var opcionInput = document.createElement("input");
        opcionInput.type = "radio";
        opcionInput.name = pregunta.id;
        opcionInput.value = opcion;

        var opcionSpan = document.createElement("span");
        opcionSpan.innerText = opcion;

        opcionItem.appendChild(opcionInput);
        opcionItem.appendChild(opcionSpan);
        opcionesList.appendChild(opcionItem);
      });

      preguntaItem.appendChild(opcionesList);
      preguntaContainer.appendChild(preguntaItem);

      if (indice === preguntas.length - 1) {
        document.getElementById("avanzarBtn").innerText = "Finalizar";
      }
    }

    function mostrarSiguientePregunta() {
      indicePregunta++;

      if (indicePregunta < preguntas.length) {
        mostrarPregunta(indicePregunta);
      } else {
        mostrarRespuestas();
        enviarRespuestas();
      }
    }

    function mostrarRespuestas() {
      var resultadoContainer = document.createElement("div");
      resultadoContainer.style.marginTop = "20px";
      respuestas.forEach(function(respuesta) {
        var pregunta = getPreguntaById(respuesta.preguntaId);
        var preguntaTexto = pregunta ? pregunta.pregunta : '';

        var respuestaItem = document.createElement("p");
        respuestaItem.innerText = "";

        resultadoContainer.appendChild(respuestaItem);
      });

      var preguntaContainer = document.getElementById("preguntaContainer");
      preguntaContainer.appendChild(resultadoContainer);

      document.getElementById("avanzarBtn").style.display = "none";
    }

    function getPreguntaById(preguntaId) {
      return preguntas.find(function(pregunta) {
        return pregunta.id === preguntaId;
      });
    }

    function enviarRespuestas() {
      var nombre = localStorage.getItem("nombre");
      var email = localStorage.getItem("email");

      respuestas.forEach(function(respuesta) {
        var enunciadoOpcion = respuesta.enunciadoOpcion;


        console.log({
          nombre: nombre,
          email: email,
          respuesta: enunciadoOpcion
        });

        var request = {
          nombre: nombre,
          email: email,
          respuesta: enunciadoOpcion
        };

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/respuesta", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              console.log("Respuesta enviada correctamente");
            } else {
              console.error("Error al enviar respuesta");
            }
          }
        };
        xhr.send(JSON.stringify(request));
      });
    }




    document.getElementById("avanzarBtn").addEventListener("click", function() {
      var preguntaSeleccionada = document.querySelector("#preguntaContainer input[type='radio']:checked");

      if (preguntaSeleccionada) {
        var preguntaItem = preguntaSeleccionada.closest("div");
        var preguntaId = preguntaItem.dataset.preguntaId;
        var opcionId = preguntaSeleccionada.value;
        var opcionTexto = preguntaSeleccionada.nextElementSibling.innerText;

        guardarRespuesta(preguntaId, opcionId, opcionTexto);
        mostrarSiguientePregunta();
      } else {
        console.log("No se seleccionó ninguna opción.");
      }
    });

    obtenerPreguntas(encuestaId);
  });

  document.addEventListener("DOMContentLoaded", function() {
    var url = window.location.href.split('?')[0];
    history.replaceState({}, document.title, url);

    var nombre = localStorage.getItem("nombre");
    var email = localStorage.getItem("email");

    console.log("Nombre: " + nombre);
    console.log("Email: " + email);
  });



</script>
</body>
</html>
